<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<title>Granos</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport">

<!-- Font Awesome -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css"
	rel="stylesheet">
<!-- Libraries Stylesheet -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link href="lib/owlcarousel/assets/owl.carousel.min.css"
	rel="stylesheet">
<link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet">

<!-- Customized Bootstrap Stylesheet -->
<link href="css/style.css" rel="stylesheet">
<!-- JavaScript Libraries -->
<!--===============================================================================================-->
<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="lib/easing/easing.min.js"></script>
<script src="lib/waypoints/waypoints.min.js"></script>
<script src="lib/owlcarousel/owl.carousel.min.js"></script>
<script src="lib/isotope/isotope.pkgd.min.js"></script>
<script src="lib/lightbox/js/lightbox.min.js"></script>

<!-- Template Javascript -->
<script src="js/main.js"></script>
<script>
	$(document)
			.ready(
					function() {
						const searchInput = $('#searchInput');
						const dropdownMenu = $('#dropdownMenu');
						const dropdownButton = $('#dropdownMenuButton');
						function populateDropdown(items) {
							dropdownMenu.empty(); // Clear existing options
							$
									.each(
											items,
											function(index, item) {
												const newName = item.nameEn
														+ ' ' + item.lastNameEn
														+ ' ('
														+ item.lastNameCn
														+ item.nameCn + ')';
												const li = $('<li>').addClass(
														'dropdown-item').text(
														newName) // Visible text
												.attr('data-value', item.empId); // Hidden value (e.g., user ID)

												// Add click event to capture the selected value
												li
														.on(
																'click',
																function() {
																	const selectedValue = $(
																			this)
																			.data(
																					'value');
																	const characterName = $('#characterName');
																	$
																			.ajax({
																				url : '/changeCharacter', // 這是你的Controller映射的URL
																				type : 'POST', // 或者 'POST'，根據你的需求
																				data : {
																					empId : selectedValue
																				}, // 傳遞empId作為請求參數
																				success : function(
																						response) {
																					const newName = response.data.character.nameEn
																							+ ' '
																							+ response.data.character.lastNameEn
																							+ ' ('
																							+ response.data.character.lastNameCn
																							+ ' '
																							+ response.data.character.nameCn
																							+ ')';
																					// 更新 h2 的文本
																					$(
																							'#navCharacter')
																							.text(
																									response.data.character.nameEn);
																					characterName
																							.text(newName);
																				},
																				error : function(
																						xhr,
																						status,
																						error) {
																					const response = JSON
																							.parse(xhr.responseText);
																					// 获取message属性的值
																					const message = response.message;
																					characterName
																							.text(message);
																				}
																			});
																});

												dropdownMenu.append(li);
											});
						}
						let items = []; // Store the dropdown items locally
						$.ajax({
							url : '/findAllUser', // Your controller URL
							method : 'GET',
							dataType : 'json', // Expecting a JSON response
							success : function(response) {
								items = response.data;
								populateDropdown(items); // Populate dropdown with response data
							},
							error : function(error) {
								populateDropdown(items);
							}
						});

						searchInput.on('input', function() {
							const searchTerm = searchInput.val().toLowerCase();
							const filteredItems = items.filter(function(item) {
								return item.username.toLowerCase().includes(
										searchTerm);
							});
							populateDropdown(filteredItems);
							if (filteredItems.length > 0) {
								dropdownMenu.addClass('show');
							} else {
								dropdownMenu.removeClass('show');
							}
						});

						$('#downloadButton')
								.on(
										'click',
										function() {
											const currentYear = new Date()
													.getFullYear();
											const specMonth = 7; // Replace with your logic to get the specific month
											const userId = user.character.empId; // Assuming you have user data available

											$
													.ajax({
														url : '/downloadPayroll',
														type : 'GET', // or 'POST' depending on your controller setup
														data : {
															year : currentYear,
															month : specMonth,
															user : userId
														},
														xhrFields : {
															responseType : 'blob' // This is important for handling binary data
														},
														success : function(
																data, status,
																xhr) {
															// Get filename from the response headers
															const contentDisposition = xhr
																	.getResponseHeader('Content-Disposition');
															const filename = contentDisposition ? contentDisposition
																	.split('filename=')[1]
																	.replace(
																			/"/g,
																			'')
																	: 'download.xlsx';

															// Create a blob and download it
															const blob = new Blob(
																	[ data ],
																	{
																		type : 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
																	});
															const url = window.URL
																	.createObjectURL(blob);
															const a = document
																	.createElement('a');
															a.href = url;
															a.download = filename;
															document.body
																	.appendChild(a);
															a.click();
															document.body
																	.removeChild(a);
															window.URL
																	.revokeObjectURL(url); // Cleanup
														},
														error : function(xhr,
																status, error) {
															console
																	.error(
																			'Download failed:',
																			error);
															alert('Failed to download the file.');
														}
													});
										});
					});
</script>
</head>
<body>
	<!-- Navbar Start -->
	<div class="container-fluid bg-white position-relative">
		<nav
			class="navbar navbar-expand-lg bg-white navbar-light py-3 py-lg-0">
			<a href="index" class="navbar-brand text-secondary">
				<h1 class="display-4 ">
					<span>G</span><span style="color: #ffcc00;">r</span><span>anos</span>
				</h1>
			</a>
			<button type="button" class="navbar-toggler"
				data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarCollapse">
				<div class="navbar-nav ml-auto py-0 pr-3">
					<a href="home" class="nav-item nav-link">Home</a> <a
						href="calendar" class="nav-item nav-link">Calendar</a> <a
						href="attendance" class="nav-item nav-link">Attendance</a> <a
						href="payroll" class="nav-item nav-link">Payroll</a> <a
						href="administrator" class="nav-item nav-link circle-background"
						th:classappend="${user.jobId != 1} ? 'disabled'"> <span
						id="navCharacter" class="border border-warning rounded-lg p-3"
						th:text="${user.character.nameEn}"></span>
					</a> <a href="logout" class="nav-item nav-link">Logout</a>
				</div>
			</div>
		</nav>
	</div>
	<!-- Navbar End -->
	<div class="container-fluid py-4">
		<div class="row">
			<h2 id="characterName"
				th:text="@{${user.character.nameEn} + ' ' + ${user.character.lastNameEn} + '(' + ${user.character.lastNameCn} + ${user.character.nameCn}} + ')' "></h2>
		</div>
		<div class="row">
			<div class="mb-3">
				<label for="searchInput" class="form-label">Search:</label> <input
					type="text" id="searchInput" class="form-control"
					placeholder="Type to filter...">
			</div>
		</div>
		<div class="row">
			<div class="col">
				<div class="dropdown">
					<button class="btn btn-primary dropdown-toggle" type="button"
						id="dropdownMenuButton" data-bs-toggle="dropdown"
						aria-expanded="false">Select a character</button>
					<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton"
						id="dropdownMenu">
						<!-- Options will be added here dynamically -->
					</ul>
				</div>
			</div>
			<div class="col">
				<button id="downloadButton" class="btn btn-primary">Download
					Payroll</button>
			</div>
		</div>
	</div>
</body>
</html>