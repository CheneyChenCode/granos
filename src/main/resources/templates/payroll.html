<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8">
    <title>Granos</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/icons/G.png"/>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">
    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
	<style type="text/css">
		.card-body {
			padding: 5px; /* 调整内边距为 10px，根据需要进行调整 */
		}
		.rounded-rectangle {
			  width: 50px; /* 设置矩形的宽度 */
			  height: 20px; /* 设置矩形的高度 */
			  background-color: #FFFFFF; /* 设置背景颜色 */
			  border: 1px solid black; /* 添加黑色边框 */
		}
		.rounded-rectangle-up {
			  width: 50px; /* 设置矩形的宽度 */
			  height: 20px; /* 设置矩形的高度 */
			  background-color: #F0655E; /* 设置背景颜色 */
			  border-radius: 10px 10px 0 0; /* 设置左上角和右上角为圆角 */
			  margin-top: 10px;
		}
		.rounded-rectangle-down {
			  width: 50px; /* 设置矩形的宽度 */
			  height: 25px; /* 设置矩形的高度 */
			  background-color: #FFFFFF; /* 设置背景颜色 */
			  border-radius: 0 0 10px 10px; /* 设置左上角和右上角为圆角 */
			  border: 2px solid #C0C0C0; /* 添加黑色边框 */
			  margin-bottom: 5px;
		}
	</style>
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
	
    <!--<script src="https://code.jquery.com/jquery-3.4.1.js"></script>-->
	<script th:inline="javascript">
        var user = /*[[${user}]]*/ 'user';
    </script>
	<script>
//     $.ajax({
//         url: 'http://localhost:9001/hello',
//         type: "GET",
//         success: function (data) {
//             console.log("跨網域請求成功:"+data);
//         },
//         error: function (data) {
//             console.log("跨網域請求失敗!!");
//         }
//     })
	// 创建一个新的 Date 对象，它将自动获取当前日期和时间
	var currentDate = new Date();

	// 获取当前年份
	var currentYear = currentDate.getFullYear();

	// 获取当前月份（注意，月份是从 0 开始计数的，所以需要加 1）
	var currentMonth = currentDate.getMonth() + 1;
	
	var specMonth=currentMonth;

$(document).ready(function() {
		let dropdownMenu = $('#monthDropdown');
    
		// Add each month up to the current month to the dropdown
		for (let month = 1; month <= currentMonth; month++) {
			const monthItem = '<a href="#" class="dropdown-item" onclick="updateDataTableAjax('+ month +')">' +currentYear+ '-' + month.toString().padStart(2, '0'); +'</a>';
			dropdownMenu.append(monthItem);
		}
    // 初始化 DataTables
    let table = $('#payrollTable').DataTable({
		info: false,
		ordering: false,
		paging: false,
		searching: false,
        processing: true, // 显示加载状态
        serverSide: true, // 开启服务器端处理模式
        ajax: {
                    url: "http://localhost:9001/getPayroll", // 外部数据源的URL
                    type: "GET", 
                    data: function(d){
							d.year = currentYear;
							d.month = specMonth;
							d.user = user.empId
					}
              },
        // 指定列定义
        columns: [
			{ data: null,
			  render: function(data, type, row) {
			  if (type === 'display') {
                return data.year + '-' + data.month ;
				}
			  }
			},
            { data: 'title' },
            { data: 'hours' },
			{ data: 'weighted' },
			{ data: 'taxFreeOverTime' },
			{ data: 'taxFreeOverTimeWeighted' }  			
        ],
		// 在列渲染完成后执行回调函数
        "createdRow": function(row, data, dataIndex) {
            // 检查特定列的数据值，并根据条件添加样式
           $('td', row).eq(0).css('background-color', '#ffc107'); // 设置背景色为黄色
        }
    });

	// 等待 DataTable 加载完成
	table.on('draw.dt', function () {
		// 获取数据
		const tableData = table.rows().data().toArray();
		let previousCellValue; // 聲明 previousCellValue 變量
		// 遍历卡片数据并创建 card 元素
		let newRow = document.createElement('div');
		newRow.className='row'; // 添加 row 类
		tableData.forEach(function(data) {
			let cardCol2Row1 = document.createElement('div');
			cardCol2Row1.className='row';
			let cardCol2Row2 = document.createElement('div');
			cardCol2Row2.className='row';
			let cardCol2Row3 = document.createElement('div');
			cardCol2Row3.className='row';
			let cardCol2Row1Label = document.createElement('div');
			cardCol2Row1Label.className='col-4 col-form-label px-1';
			cardCol2Row1Label.textContent='Title:';
			let cardCol2Row1Text = document.createElement('div');
			cardCol2Row1Text.className='col-8 form-control-plaintext font-weight-bold';
			cardCol2Row1Text.textContent = data.title;
			let cardCol2Row2Label = document.createElement('div');
			cardCol2Row2Label.className='col-4 col-form-label px-1';
			cardCol2Row2Label.textContent='Hours:'
			let cardCol2Row2Text = document.createElement('div');
			cardCol2Row2Text.className='col-8 form-control-plaintext font-weight-bold';
			cardCol2Row2Text.textContent = data.hours;
			let cardCol2Row3Label = document.createElement('div');
			cardCol2Row3Label.className='col-4 col-form-label px-1';
			cardCol2Row3Label.textContent='Weighted:';
			let cardCol2Row3Text = document.createElement('div');
			cardCol2Row3Text.className='col-2 form-control-plaintext font-weight-bold';
			cardCol2Row3Text.textContent = data.weighted;			
			
			cardCol2Row1.appendChild(cardCol2Row1Label);
			cardCol2Row1.appendChild(cardCol2Row1Text);
			cardCol2Row2.appendChild(cardCol2Row2Label);
			cardCol2Row2.appendChild(cardCol2Row2Text);
			cardCol2Row3.appendChild(cardCol2Row3Label);
			cardCol2Row3.appendChild(cardCol2Row3Text);
			
			let cardCol2 = document.createElement('div');
			cardCol2.className='col-10';
			cardCol2.appendChild(cardCol2Row1);
			cardCol2.appendChild(cardCol2Row2);
			cardCol2.appendChild(cardCol2Row3);
			// 创建 card 元素
			let newCol = document.createElement('div');
			newCol.className='col-sm-5 mb-4'; 
			let cardRow = document.createElement('div');
			cardRow.className='d-flex flex-row';
			cardRow.appendChild(cardCol2);
			let newCard = document.createElement('div');
			newCard.classList.add('card');
			let cardBody = document.createElement('div');
			cardBody.className='card-body'; 
			
			cardBody.appendChild(cardRow);
			newCard.appendChild(cardBody);
			newCol.appendChild(newCard);
			newRow.appendChild(newCol);
		});
		let table2 = $('#table2');
		table2.empty().append(newRow);
	});
	// 监听链接点击事件
	$('#preMonth').click(function(event) {
		// 阻止链接的默认行为
		event.preventDefault();
		
		// 调用相应的函数或执行其他操作
		// 这里调用你想要触发的函数
		updateDataTableAjax(currentMonth-1);
	});
	$('#currMonth').click(function(event) {
		// 阻止链接的默认行为
		event.preventDefault();
		
		// 调用相应的函数或执行其他操作
		// 这里调用你想要触发的函数
		updateDataTableAjax(currentMonth);
	});
	if (isMobileDevice()) {
         activeTab2(); // 根据您的选项卡的ID进行修改
    }else{
		activeTab1();
	}

});
    function isMobileDevice() {
        return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
    }
	function activeTab1() {
	  let icon = $('#icon');
	  $('#table1-tab').tab('show');
	  icon.removeClass('fa-table').addClass('fa-list');
	}
	function activeTab2() {
	  let icon = $('#icon');
	  $('#table2-tab').tab('show');
	  icon.removeClass('fa-list').addClass('fa-table');
	}
	function switchTab() {
	  if ($('#table1-tab').hasClass('active')) {
		  activeTab2();
	  } else {
		  $('#table1-tab').tab('show');
		  activeTab1();
	  }
	}
	function updateDataTableAjax(month) {
		// 获取 DataTable 实例
		let table = $('#payrollTable').DataTable();
		specMonth=month;
		table.ajax.reload(); // 重新加载数据
	}

    </script>
  </head>
  <body>
  	<!-- Navbar Start -->
    <div class="container-fluid bg-white position-relative">
        <nav class="navbar navbar-expand-lg bg-white navbar-light py-3 py-lg-0">
            <a href="index" class="navbar-brand text-secondary">
                <h1 class="display-4 ">
					<span>G</span><span style="color:#ffcc00;">r</span><span>anos</span>
				</h1>
            </a>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="navbar-nav ml-auto py-0 pr-3">
                    <a href="home" class="nav-item nav-link">Home</a>
                    <a href="calendar" class="nav-item nav-link">Calendar</a>
                    <a href="attendance" class="nav-item nav-link">Attendance</a>
                    <a href="payroll" class="nav-item nav-link active">Payroll</a>
                    <a href="project.html" class="nav-item nav-link">Projects</a>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Pages</a>
                        <div class="dropdown-menu rounded-0 m-0">
                            <a href="team.html" class="dropdown-item">Meat The Team</a>
                            <a href="testimonial.html" class="dropdown-item">Testimonial</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->
	<div class="container">
		<div class="row">
			<div class="col">
				<!-- Bootstrap 标签页 -->
				<button class="btn btn-primary" type="button" onclick="switchTab()"><i id="icon" class="fas fa-list"></i></button>
				<button class="btn btn-primary" type="button" onclick="switchTab()"><i class="fa fa-download"></i></button>
			</div>
			<div class="col d-flex justify-content-end">
			  <div class="dropdown">
					<a href="#" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"><i class="far fa-clock"></i></a>
					<div id="monthDropdown" class="dropdown-menu rounded-0 m-0">
					</div>
			  </div>
			</div>
		</div>
		<div class="row">
			<ul class="nav nav-tabs" id="myTab" role="tablist">
				<li class="nav-item" role="presentation">
					<a class="nav-link" id="table1-tab" data-toggle="tab" href="#table1" role="tab"
					   aria-controls="table1" aria-selected="true" hidden=true>Table 1</a>
				</li>
				<li class="nav-item" role="presentation">
					<a class="nav-link" id="table2-tab" data-toggle="tab" href="#table2" role="tab"
					   aria-controls="table2" aria-selected="false" hidden=true>Table 2</a>
				</li>
			</ul>
			<!-- 标签页内容 -->
			<div class="tab-content" id="myTabContent">
				<div class="tab-pane fade" id="table1" role="tabpanel" aria-labelledby="table1-tab">
					<table id="payrollTable" class="table table-striped table-bordered">
						<thead>
						<tr>
							<th>MONTH</th>
							<th>TITLE</th>
							<th>HOURS</th>
							<th>WEIGHTED HOURS</th>
							<th>TAX FREE OVERTIME</th>
							<th>WEIGHTED TAX FREE OVERTIME</th>
						</tr>
						</thead>
						<tbody>
						<!-- 数据将在这里动态生成 -->
						</tbody>
					</table>
				</div>
				<div class="tab-pane fade" id="table2" role="tabpanel" aria-labelledby="table2-tab">
				</div>
			</div>
		</div>
   
</div>
	   <!-- JavaScript Libraries -->
	<!--===============================================================================================-->

    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/isotope/isotope.pkgd.min.js"></script>
    <script src="lib/lightbox/js/lightbox.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
  </body>
</html>